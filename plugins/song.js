
/* ðŸ†•Copyright (C) 2020 Yusuf Usta.
Licensed under the  GPL-3.0 License;
you may not use this file except in compliance with the License.
WhatsAsena - Yusuf Usta
*/

const Asena = require('../events');
const {MessageType,Mimetype} = require('@adiwajshing/baileys');
const translatte = require('translatte');
const config = require('../config');
const LanguageDetect = require('languagedetect');
const lngDetector = new LanguageDetect();
const Heroku = require('heroku-client');
const heroku = new Heroku({
    token: config.HEROKU.API_KEY
});
let baseURI = '/apps/' + config.HEROKU.APP_NAME;
//============================== LYRICS =============================================
const axios = require('axios');
const { requestLyricsFor, requestAuthorFor, requestTitleFor, requestIconFor } = require("solenolyrics");
const solenolyrics= require("solenolyrics"); 
//============================== CURRENCY =============================================
const { exchangeRates } = require('exchange-rates-api');
const ExchangeRatesError = require('exchange-rates-api/src/exchange-rates-error.js')
//============================== TTS ==================================================
const fs = require('fs');
const https = require('https');
const googleTTS = require('google-translate-tts');
//=====================================================================================
//============================== YOUTUBE ==============================================
const ytdl = require('ytdl-core');
const ffmpeg = require('fluent-ffmpeg');
const yts = require( 'yt-search' )
const got = require("got");
const ID3Writer = require('browser-id3-writer');
const SpotifyWebApi = require('spotify-web-api-node');

const spotifyApi = new SpotifyWebApi({
    clientId: 'acc6302297e040aeb6e4ac1fbdfd62c3',
    clientSecret: '0e8439a1280a43aba9a5bc0a16f3f009'
});
//=====================================================================================
const Language = require('../language');
const Lang = Language.getString('scrapers');
const Glang = Language.getString('github');
const Slang = Language.getString('lyrics');
const Clang = Language.getString('covid');

const wiki = require('wikijs').default;
var gis = require('g-i-s');

var dlang_dsc = ''
var closer_res = ''
var dlang_lang = ''
var dlang_similarity = ''
var dlang_other = ''
var dlang_input = ''

if (config.LANG == 'TR') {
    dlang_dsc = 'YanÄ±tlanan mesajÄ±n dilini tahmin eder.'
    closer_res = 'En YakÄ±n SonuÃ§:'
    dlang_lang = 'Dil:'
    dlang_similarity = 'Benzerlik:'
    dlang_other = 'DiÄŸer Diller'
    dlang_input = 'Ä°ÅŸlenen Metin:'
}
if (config.LANG == 'EN') {
    dlang_dsc = 'Guess the language of the replied message.'
    closer_res = 'Closest Result:'
    dlang_lang = 'Language:'
    dlang_similarity = 'Similarity:'
    dlang_other = 'Other Languages'
    dlang_input = 'Processed Text:'
}
if (config.LANG == 'AZ') {
    dlang_dsc = 'Cavablanan mesajÄ±n dilini tÉ™xmin edin.'
    closer_res = 'Æn yaxÄ±n nÉ™ticÉ™:'
    dlang_lang = 'Dil:'
    dlang_similarity = 'BÉ™nzÉ™rlik:'
    dlang_other = 'BaÅŸqa DillÉ™r'
    dlang_input = 'Ä°ÅŸlÉ™nmiÅŸ MÉ™tn:'
}
if (config.LANG == 'ML') {
    dlang_dsc = 'à´®à´±àµà´ªà´Ÿà´¿ à´¨àµ½à´•à´¿à´¯ à´¸à´¨àµà´¦àµ‡à´¶à´¤àµà´¤à´¿à´¨àµà´±àµ† à´­à´¾à´· ess à´¹à´¿à´•àµà´•àµà´•.'
    closer_res = 'à´à´±àµà´±à´µàµà´‚ à´…à´Ÿàµà´¤àµà´¤ à´«à´²à´‚:'
    dlang_lang = 'à´¨à´¾à´µàµ:'
    dlang_similarity = 'à´¸à´®à´¾à´¨à´¤:'
    dlang_other = 'à´®à´±àµà´±àµ à´­à´¾à´·à´•àµ¾'
    dlang_input = 'à´ªàµà´°àµ‹à´¸à´¸àµà´¸àµ à´šàµ†à´¯àµà´¤ à´µà´¾à´šà´•à´‚:'
}
if (config.LANG == 'HI') {
    dlang_dsc = 'à¤‰à¤¤à¥à¤¤à¤° à¤¦à¤¿à¤ à¤—à¤ à¤¸à¤‚à¤¦à¥‡à¤¶ à¤•à¥€ à¤­à¤¾à¤·à¤¾ à¤•à¤¾ à¤…à¤¨à¥à¤®à¤¾à¤¨ à¤²à¤—à¤¾à¤à¤‚'
    closer_res = 'à¤¨à¤¿à¤•à¤Ÿà¤¤à¤® à¤ªà¤°à¤¿à¤£à¤¾à¤®:'
    dlang_lang = 'à¤œà¥à¤¬à¤¾à¤¨:'
    dlang_similarity = 'à¤¸à¤®à¤¾à¤¨à¤¤à¤¾:'
    dlang_other = 'à¤…à¤¨à¥à¤¯ à¤­à¤¾à¤·à¤¾à¤à¤'
    dlang_input = 'à¤¸à¤‚à¤¸à¤¾à¤§à¤¿à¤¤ à¤ªà¤¾à¤ :'
}
if (config.LANG == 'ES') {
    dlang_dsc = 'Adivina el idioma del mensaje respondido.'
    closer_res = 'Resultado mÃ¡s cercano:'
    dlang_lang = 'Lengua:'
    dlang_similarity = 'Semejanza:'
    dlang_other = 'Otros idiomas:'
    dlang_input = 'Texto procesado:'
}
if (config.LANG == 'PT') {
    dlang_dsc = 'Adivinhe o idioma da mensagem respondida.'
    closer_res = 'Resultado mais prÃ³ximo:'
    dlang_lang = 'LÃ­ngua:'
    dlang_similarity = 'Similaridade:'
    dlang_other = 'Outras lÃ­nguas'
    dlang_input = 'Texto Processado:'
}
if (config.LANG == 'ID') {
    dlang_dsc = 'Tebak bahasa pesan yang dibalas.'
    closer_res = 'Hasil Terdekat:'
    dlang_lang = 'Lidah:'
    dlang_similarity = 'Kesamaan:'
    dlang_other = 'Bahasa Lainnya'
    dlang_input = 'Teks yang Diproses:'
}
if (config.LANG == 'RU') {
    dlang_dsc = 'Ð£Ð³Ð°Ð´Ð°Ð¹ ÑÐ·Ñ‹Ðº Ð¾Ñ‚Ð²ÐµÑ‚Ð½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ.'
    closer_res = 'Ð‘Ð»Ð¸Ð¶Ð°Ð¹ÑˆÐ¸Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚:'
    dlang_lang = 'Ð¯Ð·Ñ‹Ðº:'
    dlang_similarity = 'Ð¡Ñ…Ð¾Ð´ÑÑ‚Ð²o:'
    dlang_other = 'Ð”Ñ€ÑƒÐ³Ð¸Ðµ ÑÐ·Ñ‹ÐºÐ¸'
    dlang_input = 'ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ð½Ð½Ñ‹Ð¹ Ñ‚ÐµÐºÑÑ‚:'
}


if (config.WORKTYPE == 'private') {

    
    var l_dsc = ''
    var alr_on = ''
    var alr_off = ''
    var succ_on = ''
    var succ_off = ''
    if (config.LANG == 'TR') {
        l_dsc = 'Antilink aracÄ±nÄ± etkinleÅŸtirir.'
        alr_on = 'Antilink halihazÄ±rda aÃ§Ä±k!'
        alr_off = 'Antilink halihazÄ±rda kapalÄ±!'
        succ_on = 'Antilink BaÅŸarÄ±yla AÃ§Ä±ldÄ±!'
        succ_off = 'Antilink BaÅŸarÄ±yla KapatÄ±ldÄ±!'
    }
    if (config.LANG == 'EN') {
        l_dsc = 'Activates the Antilink tool.'
        alr_on = 'Antilink is already open!'
        alr_off = 'Antilink is currently closed!'
        succ_on = 'Antilink Opened Successfully!'
        succ_off = 'Antilink Closed Successfully!'
    }
    if (config.LANG == 'AZ') {
        l_dsc = 'Antilink alÉ™tini aktivlÉ™ÅŸdirir.'
        alr_on = 'Antilink hazÄ±rda aÃ§Ä±qdÄ±r!'
        alr_off = 'Antilink hazÄ±rda baÄŸlÄ±dÄ±r!'
        succ_on = 'Antilink UÄŸurla AÃ§Ä±ldÄ±!'
        succ_off = 'Antilink UÄŸurla BaÄŸlandÄ±!'
    }
    if (config.LANG == 'HI') {
        l_dsc = 'à¤à¤‚à¤Ÿà¥€à¤²à¤¿à¤‚à¤• à¤Ÿà¥‚à¤² à¤•à¥‹ à¤¸à¤•à¥à¤°à¤¿à¤¯ à¤•à¤°à¤¤à¤¾ à¤¹à¥ˆà¥¤'
        alr_on = 'à¤à¤‚à¤Ÿà¥€à¤²à¤¿à¤‚à¤• à¤ªà¤¹à¤²à¥‡ à¤¸à¥‡ à¤¹à¥€ à¤–à¥à¤²à¤¾ à¤¹à¥ˆ!'
        alr_off = 'à¤à¤‚à¤Ÿà¥€à¤²à¤¿à¤‚à¤• à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤®à¥‡à¤‚ à¤¬à¤‚à¤¦ à¤¹à¥ˆ!'
        succ_on = 'à¤à¤‚à¤Ÿà¥€à¤²à¤¿à¤‚à¤• à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤–à¥‹à¤²à¤¾ à¤—à¤¯à¤¾!'
        succ_off = 'à¤à¤‚à¤Ÿà¥€à¤²à¤¿à¤‚à¤• à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤¬à¤‚à¤¦!'
    }
    if (config.LANG == 'ML') {
        l_dsc = 'à´†à´¨àµà´±à´¿à´²à´¿à´™àµà´•àµ à´‰à´ªà´•à´°à´£à´‚ à´¸à´œàµ€à´µà´®à´¾à´•àµà´•àµà´¨àµà´¨àµ.'
        alr_on = 'à´†à´¨àµà´±à´¿à´²à´¿à´™àµà´•àµ à´‡à´¤à´¿à´¨à´•à´‚ à´¤àµà´±à´¨àµà´¨àµ!'
        alr_off = 'à´†à´¨àµà´±à´¿à´²à´¿à´™àµà´•àµ à´¨à´¿à´²à´µà´¿àµ½ à´…à´Ÿà´šàµà´šà´¿à´°à´¿à´•àµà´•àµà´¨àµà´¨àµ!'
        succ_on = 'à´†à´¨àµà´±à´¿à´²à´¿à´™àµà´•àµ à´µà´¿à´œà´¯à´•à´°à´®à´¾à´¯à´¿ à´¤àµà´±à´¨àµà´¨àµ!'
        succ_off = 'à´†à´¨àµà´±à´¿à´²à´¿à´™àµà´•àµ à´µà´¿à´œà´¯à´•à´°à´®à´¾à´¯à´¿ à´…à´Ÿà´šàµà´šàµ!'
    }
    if (config.LANG == 'PT') {
        l_dsc = 'Ativa a ferramenta Antilink.'
        alr_on = 'O Antilink jÃ¡ estÃ¡ aberto!'
        alr_off = 'Antilink estÃ¡ fechado no momento!'
        succ_on = 'Antilink aberto com sucesso!'
        succ_off = 'Antilink fechado com sucesso!'
    }
    if (config.LANG == 'RU') {
        l_dsc = 'ÐÐºÑ‚Ð¸Ð²Ð¸Ñ€ÑƒÐµÑ‚ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐ¼ÐµÐ½Ñ‚ Antilink.'
        alr_on = 'ÐÐ½Ñ‚Ð¸Ð»Ð¸Ð½Ðº ÑƒÐ¶Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚!'
        alr_off = 'ÐÐ½Ñ‚Ð¸Ð»Ð¸Ð½Ðº ÑÐµÐ¹Ñ‡Ð°Ñ Ð·Ð°ÐºÑ€Ñ‹Ñ‚!'
        succ_on = 'ÐÐ½Ñ‚Ð¸Ð»Ð¸Ð½Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚!'
        succ_off = 'ÐÐ½Ñ‚Ð¸Ð»Ð¸Ð½Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°ÐºÑ€Ñ‹Ñ‚!'
    }
    if (config.LANG == 'ES') {
        l_dsc = 'Activa la herramienta Antilink.'
        alr_on = 'Â¡Antilink ya estÃ¡ abierto!'
        alr_off = 'Â¡Antilink estÃ¡ cerrado actualmente!'
        succ_on = 'Â¡Antilink se abriÃ³ con Ã©xito!'
        succ_off = 'Antilink cerrado correctamente!'
    }
    if (config.LANG == 'ID') {
        l_dsc = 'Mengaktifkan alat Antilink.'
        alr_on = 'Antilink sudah terbuka!'
        alr_off = 'Antilink saat ini ditutup!'
        succ_on = 'Antilink Berhasil Dibuka!'
        succ_off = 'Antilink Berhasil Ditutup!'
    }
   
    var auto_dsc = ''
    var alr_on_bio = ''
    var alr_off_bio = ''
    var succ_on_bio = ''
    var succ_off_bio = ''
    if (config.LANG == 'TR') {
        auto_dsc = 'Biyografinize canlÄ± saat ekleyin!'
        alr_on_bio = 'Autobio halihazÄ±rda aÃ§Ä±k!'
        alr_off_bio = 'Autobio halihazÄ±rda kapalÄ±!'
        succ_on_bio = 'Autobio BaÅŸarÄ±yla AÃ§Ä±ldÄ±!'
        succ_off_bio = 'Autobio BaÅŸarÄ±yla KapatÄ±ldÄ±!'
    }
    if (config.LANG == 'EN') {
        auto_dsc = 'Add live clock to your bio!'
        alr_on_bio = 'Autobio is already open!'
        alr_off_bio = 'Autobio is currently closed!'
        succ_on_bio = 'Autobio Opened Successfully!'
        succ_off_bio = 'Autobio Closed Successfully!'
    }
    if (config.LANG == 'AZ') {
        auto_dsc = 'Bio-ya canlÄ± saat É™lavÉ™ et!'
        alr_on_bio = 'Autobio hazÄ±rda aÃ§Ä±qdÄ±r!'
        alr_off_bio = 'Autobio hazÄ±rda baÄŸlÄ±dÄ±r!'
        succ_on_bio = 'Autobio UÄŸurla AÃ§Ä±ldÄ±!'
        succ_off_bio = 'Autobio UÄŸurla BaÄŸlandÄ±!'
    }
    if (config.LANG == 'HI') {
        auto_dsc = 'à¤…à¤ªà¤¨à¥‡ à¤¬à¤¾à¤¯à¥‹ à¤®à¥‡à¤‚ à¤²à¤¾à¤‡à¤µ à¤˜à¤¡à¤¼à¥€ à¤œà¥‹à¤¡à¤¼à¥‡à¤‚!'
        alr_on_bio = 'Autobio à¤ªà¤¹à¤²à¥‡ à¤¸à¥‡ à¤¹à¥€ à¤–à¥à¤²à¤¾ à¤¹à¥ˆ!'
        alr_off_bio = 'Autobio à¤µà¤°à¥à¤¤à¤®à¤¾à¤¨ à¤®à¥‡à¤‚ à¤¬à¤‚à¤¦ à¤¹à¥ˆ!'
        succ_on_bio = 'Autobio à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤–à¥‹à¤²à¤¾ à¤—à¤¯à¤¾!'
        succ_off_bio = 'Autobio à¤¸à¤«à¤²à¤¤à¤¾à¤ªà¥‚à¤°à¥à¤µà¤• à¤¬à¤‚à¤¦!'
    }
    if (config.LANG == 'ML') {
        auto_dsc = 'à´¨à´¿à´™àµà´™à´³àµà´Ÿàµ† à´¬à´¯àµ‹à´¯à´¿à´²àµ‡à´•àµà´•àµ à´¤à´¤àµà´¸à´®à´¯ à´•àµà´²àµ‹à´•àµà´•àµ à´šàµ‡àµ¼à´•àµà´•àµà´•!'
        alr_on_bio = 'Autobio à´‡à´¤à´¿à´¨à´•à´‚ à´¤àµà´±à´¨àµà´¨àµ!'
        alr_off_bio = 'Autobio à´¨à´¿à´²à´µà´¿àµ½ à´…à´Ÿà´šàµà´šà´¿à´°à´¿à´•àµà´•àµà´¨àµà´¨àµ!'
        succ_on_bio = 'Autobio à´µà´¿à´œà´¯à´•à´°à´®à´¾à´¯à´¿ à´¤àµà´±à´¨àµà´¨àµ!'
        succ_off_bio = 'Autobio à´µà´¿à´œà´¯à´•à´°à´®à´¾à´¯à´¿ à´…à´Ÿà´šàµà´šàµ!'
    }
    if (config.LANG == 'PT') {
        auto_dsc = 'Adicione um relÃ³gio ao vivo Ã  sua biografia!'
        alr_on_bio = 'O Autobio jÃ¡ estÃ¡ aberto!'
        alr_off_bio = 'Autobio estÃ¡ fechado no momento!'
        succ_on_bio = 'Autobio aberto com sucesso!'
        succ_off_bio = 'Autobio fechado com sucesso!'
    }
    if (config.LANG == 'RU') {
        auto_dsc = 'Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð¶Ð¸Ð²Ñ‹Ðµ Ñ‡Ð°ÑÑ‹ Ð² ÑÐ²Ð¾ÑŽ Ð±Ð¸Ð¾Ð³Ñ€Ð°Ñ„Ð¸ÑŽ!'
        alr_on_bio = 'Autobio ÑƒÐ¶Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚!'
        alr_off_bio = 'Autobio ÑÐµÐ¹Ñ‡Ð°Ñ Ð·Ð°ÐºÑ€Ñ‹Ñ‚!'
        succ_on_bio = 'Autobio ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚!'
        succ_off_bio = 'Autobio ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°ÐºÑ€Ñ‹Ñ‚!'
    }
    if (config.LANG == 'ES') {
        auto_dsc = 'Â¡Agrega un reloj en vivo a tu biografÃ­a!'
        alr_on_bio = 'Â¡Autobio ya estÃ¡ abierto!'
        alr_off_bio = 'Â¡Autobio estÃ¡ cerrado actualmente!'
        succ_on_bio = 'Â¡Autobio se abriÃ³ con Ã©xito!'
        succ_off_bio = 'Autobio cerrado correctamente!'
    }
    if (config.LANG == 'ID') {
        auto_dsc = 'Tambahkan jam langsung ke bio Anda!'
        alr_on_bio = 'Autobio sudah terbuka!'
        alr_off_bio = 'Autobio saat ini ditutup!'
        succ_on_bio = 'Autobio Berhasil Dibuka!'
        succ_off_bio = 'Autobio Berhasil Ditutup!'
    }
   
    Asena.addCommand({pattern: 'song ?(.*)', fromMe: true,  deleteCommand: true,  desc: Lang.SONG_DESC}, (async (message, match) => { 

        if (match[1] === '') return await message.client.sendMessage(message.jid,Lang.NEED_TEXT_SONG,MessageType.text);    
        let arama = await yts(match[1]);
        arama = arama.all;
        if(arama.length < 1) return await message.client.sendMessage(message.jid,Lang.NO_RESULT,MessageType.text);
        var reply = await message.client.sendMessage(message.jid,Lang.DOWNLOADING_SONG,MessageType.text);

        let title = arama[0].title.replace(' ', '+');
        let stream = ytdl(arama[0].videoId, {
            quality: 'highestaudio',
        });
    
        got.stream(arama[0].image).pipe(fs.createWriteStream(title + '.jpg'));
        ffmpeg(stream)
            .audioBitrate(320)
            .save('./' + title + '.mp3')
            .on('end', async () => {
                const writer = new ID3Writer(fs.readFileSync('./' + title + '.mp3'));
                writer.setFrame('TIT2', arama[0].title)
                    .setFrame('TPE1', [arama[0].author.name])
                    .setFrame('APIC', {
                        type: 3,
                        data: fs.readFileSync(title + '.jpg'),
                        description: arama[0].description
                    });
                writer.addTag();

                reply = await message.client.sendMessage(message.jid,Lang.UPLOADING_SONG,MessageType.text);
                await message.client.sendMessage(message.jid,Buffer.from(writer.arrayBuffer), MessageType.audio, {mimetype: Mimetype.mp4Audio, ptt: false});
            });
    }));

    

}
else if (config.WORKTYPE == 'public') {

    
    Asena.addCommand({pattern: 'song ?(.*)', fromMe: false, desc: Lang.SONG_DESC}, (async (message, match) => { 

        if (match[1] === '') return await message.client.sendMessage(message.jid,Lang.NEED_TEXT_SONG,MessageType.text);    
        let arama = await yts(match[1]);
        arama = arama.all;
        if(arama.length < 1) return await message.client.sendMessage(message.jid,Lang.NO_RESULT,MessageType.text);
        var reply = await message.client.sendMessage(message.jid,config.SONGD,MessageType.text, {quoted: message.data});

        let title = arama[0].title.replace(' ', '+');
        let stream = ytdl(arama[0].videoId, {
            quality: 'highestaudio',
        });
    
        got.stream(arama[0].image).pipe(fs.createWriteStream(title + '.jpg'));
        ffmpeg(stream)
            .audioBitrate(320)
            .save('./' + title + '.mp3')
            .on('end', async () => {
                const writer = new ID3Writer(fs.readFileSync('./' + title + '.mp3'));
                writer.setFrame('TIT2', arama[0].title)
                    .setFrame('TPE1', [arama[0].author.name])
                    .setFrame('APIC', {
                        type: 3,
                        data: fs.readFileSync(title + '.jpg'),
                        description: arama[0].description
                    });
                writer.addTag();

                reply = await message.client.sendMessage(message.jid,config.SONGU,MessageType.text, {quoted: message.data});
                await message.client.sendMessage(message.jid,Buffer.from(writer.arrayBuffer), MessageType.audio, {mimetype: Mimetype.mp4Audio, ptt: false, quoted: message.data});
            });
    }));

   
    
}
